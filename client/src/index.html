<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Phaser multiplayer game</title>
    <script src="//localhost:35729/livereload.js"></script>
    <script type="text/javascript" src="js/phaser.js"></script>
    <script type="text/javascript" src="js/shared.gen.js"></script>
    <script type="text/javascript" src="js/network/Connection.js"></script>
    <script type="text/javascript" src="js/network/Router.js"></script>
    <script type="text/javascript" src="js/network/State.js"></script>
    <script type="text/javascript" src="js/game/Player.js"></script>
    <script type="text/javascript" src="js/game/VisualState.js"></script>
    
    <script type="text/javascript" src="js/utils/Input.js"></script>
    <script type="text/javascript" src="js/utils/Factory.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(
        1024, 600, Phaser.AUTO, '', 
        { preload: preload, create: create, update: update }
    );

Facade = function() {}
Facade.prototype.constructor = Facade;


var networkState;
var visualState;
var input;
var connection;

function preload() {
    game.load.image('test', 'assets/test.png');
    game.load.image('loading', 'assets/loading.png');
}

function create() {
    Facade.game = game;
    Facade.factory = new Factory(game);
    Facade.queue = new ActionQueue();
    networkState = Facade.networkState = new State();
    visualState = Facade.visualState = new VisualState(game, networkState);

    var loadingSprite = game.add.sprite(10, 10, 'loading');

    connection = new Connection('188.242.130.83', 3000);
    connection.connect(function() {
        connection.calculateMedian();
        game.world.remove(loadingSprite);
    });

    input = new Input(connection.pushControls, connection);
}

function update() {
    if (!connection.isReady || connection.isCalculatingMedian) return;

    var dt = game.time.elapsed / 1000;
    input.update(game.time.elapsed);
    visualState.update(dt);
}

</script>

</body>
</html>