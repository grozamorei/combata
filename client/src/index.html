<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Phaser multiplayer game</title>
    <script src="//localhost:35729/livereload.js"></script>
    
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <script type="text/javascript" src="js/shared.gen.js"></script>

    <script type="text/javascript" src="js/network/ServerSync.js"></script>
    <script type="text/javascript" src="js/network/Connection.js"></script>
    <script type="text/javascript" src="js/network/Router.js"></script>
    <script type="text/javascript" src="js/network/State.js"></script>
    <script type="text/javascript" src="js/network/lerp/Interpolator.js"></script>
    <script type="text/javascript" src="js/network/lerp/InterpolatorNode.js"></script>
    <script type="text/javascript" src="js/network/lerp/InterpolatorNodeProperty.js"></script>

    <script type="text/javascript" src="js/game/Player.js"></script>
    <script type="text/javascript" src="js/game/PlayerVisual.js"></script>
    <script type="text/javascript" src="js/game/VisualState.js"></script>
    
    <script type="text/javascript" src="js/utils/Input.js"></script>
    <script type="text/javascript" src="js/utils/Factory.js"></script>
    <script type="text/javascript" src="js/utils/settings_loader.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(
        600, 512, Phaser.AUTO, '', 
        { preload: preload, create: create, update: update }
    );

Facade = function() {}
Facade.prototype.constructor = Facade;

var networkState;
var visualState;
var input;
var connection;

function preload() {
    game.load.image('player_sprite', 'assets/test_player.png');
    game.load.image('player_dir_arrow', 'assets/test_arrow.png');
    game.load.image('loading', 'assets/loading.png');
}

function create() {
    game.stage.disableVisibilityChange = true;
    Facade.myId = -1;
    Facade.game = game;
    Facade.params = GameParams;
    Facade.factory = new Factory(game);
    Facade.simulation = new Simulation();
    networkState = Facade.networkState = new State();

    var loadingSprite = game.add.sprite(10, 10, 'loading');

    loadJson('assets/' + Facade.params.startMap, function(data) {
        Facade.level = new LevelModel().fromTiledDescriptor(data);
        Facade.simulation.physics.addStaticBodies(Facade.level.bodies);
        visualState = Facade.visualState = new VisualState(game, networkState, Facade.level);
        game.world.setBounds(-20, -20, Facade.level.width+40, Facade.level.height+60);


        loadJson('assets/platform_settings.json', function(settings) {
            console.log('settings loaded:', settings);
            Facade.connection = connection = new Connection(settings.server_address, settings.server_port);
            connection.connect(function() {
                connection.calculateMedian();
                game.world.remove(loadingSprite);
            });

            input = new Input(connection.sendVelocity, connection, connection.sendPointer, connection);
        });    
    });

    
}

function update() {
    if (!connection || !connection.isReady) {
        // console.log('cannot update');
        return;
    }
    var dt = game.time.elapsed;
    connection.sync.update();
    input.update(dt);
    networkState.interpolator.update(dt);
    visualState.update(dt);
}

</script>

</body>
</html>